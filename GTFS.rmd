---
title: "Bus_Data_Extraction"
author: "Leonardo Phu"
date: '2023-03-07'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Load libaries
library(tidyverse)
library(jsonlite)
library(httr)

#Obtain Key - Leos Key 
key = "567bb1fb7ab64582905c7812648075e1"
```

```{r}
main = getwd()
```

```{r}
#Reading in static files 
setwd(paste(main, '/rawdata/businfo', sep = ""))
stops = read.table("stops.txt", header = TRUE, sep = ",", quote = "")

stop_times = read.table("stop_times.txt", header = TRUE, sep = ",", quote = "")

nrow(stop_times)

trips = read.table("trips.txt", header = TRUE, sep = ",", quote = ",", fill = TRUE)

routes = read.table("routes.txt", header = TRUE, sep = ",", quote = "")

shapes = read.table("shapes.txt", header = TRUE, sep = ",", quote = "")

stop_times = stop_times %>% mutate(stop_code = substring(stop_id, 1, regexpr("-", stop_id)[1] - 1))
```

```{r}
#All information

#Writing to gtfs for the 

combined_feed<-tryCatch(
  GET('https://api.at.govt.nz/realtime/legacy/',
      accept_json(),
      add_headers('Ocp-Apim-Subscription-Key' = key)),
  error=function(e) NULL)

vehcile<-tryCatch(
  GET('https://api.at.govt.nz/realtime/legacy/vehiclelocations',
      accept_json(),
      add_headers('Ocp-Apim-Subscription-Key' = key)),
  error=function(e) NULL)


```


```{r}
#Read in data
#Json File

#trip_updates file
gtfs_trips<-tryCatch(
  GET('https://api.at.govt.nz/realtime/legacy/tripupdates',
      accept_json(),
      add_headers('Ocp-Apim-Subscription-Key' = key)),
  error=function(e) NULL)

#alerts files

alerts <- tryCatch(
  GET('https://api.at.govt.nz/realtime/legacy/servicealerts',
      accept_json(),
      add_headers('Ocp-Apim-Subscription-Key' = key)),
  error=function(e) NULL)
```

```{r}

write_json(content(gtfs_trips), "/Users/leonardophu/Desktop/2023/STATS 765/PROJECT/Files/Trip_Updates_8April_13.json", pretty = TRUE)

write_json(content(alerts), "/Users/leonardophu/Desktop/2023/STATS 765/PROJECT/Files/Alert_Service_8April_13.json", pretty = TRUE)

write_json(content(vehcile), "/Users/leonardophu/Desktop/2023/STATS 765/PROJECT/Files/vehcile_8April_13.json", pretty = TRUE)

write_json(content(combined_feed), "/Users/leonardophu/Desktop/2023/STATS 765/PROJECT/Files/combined_feed_8April_13.json", pretty = TRUE)
```

```{r}
trip_content = content(gtfs_trips)[[2]][[2]]

#trip_content = temp[[2]][[2]]

length(trip_content)

#head(str(trip_content), level = 3)

head(trip_content)

#Helper Functions

n = function(x) if(is.null(x)) NA else x

trips = trips %>% filter(trip_id != "trip_id")

trip_data = as.data.frame(do.call(rbind, lapply(trip_content, 
                                                function(x) c(n(x$trip_update$trip$trip_id),
                                                              n(x$trip_update$trip$direction_id),
                                                              n(x$trip_update$trip$route_id),
                                                              n(x$trip_update$stop_time_update$stop_id),
                                                              n(x$trip_update$trip$schedule_relationship),
                                                              n(x$trip_update$delay), 
                                                              n(x$trip_update$stop_time_update$stop_sequence),
                                                              n(x$trip_update$stop_time_update$arrival$time),
                                                              n(x$trip_update$stop_time_update$arrival$delay),
                                                              n(x$trip_update$stop_time_update$departure$time),
                                                              n(x$trip_update$stop_time_update$departure$delay)
                                                ))))

colnames(trip_data) = c("trip_id", 
                        "direction_id", 
                        "route_id", 
                        "stop_id", 
                        "schedule_relationship", 
                        "delay", 
                        "stop_sequence", 
                        "act_arrival_time", 
                        "arrival_delay", 
                        "act_departure_time", 
                        "act_departure_delay")

#Converting our types to be able to join 
trip_data$stop_sequence = as.integer(trip_data$stop_sequence)

```

```{r}
#Now alerts are different 
alert_contents = content(alerts)

alert_data = as.data.frame(do.call(rbind, lapply(alert_contents[[2]][[2]], function(x) c(n(x$id), n(x$alert$effect), n(x$alert$header_text$translation[[1]]$text), n(x$alert$informed_entity[[1]]$trip$trip_id)))))

colnames(alert_data) = c("id", "effect", "text", "trip_id")
alert_temp1 = alert_data

View(alert_contents)



alert_temp1$trip_id = ifelse(alert_temp1$trip_id == alert_temp1$id, NA, alert_temp1$trip_id)
cancelled_buses = alert_temp1 %>% filter(is.na(trip_id) == FALSE) %>% select(trip_id) %>% mutate(cancelled = TRUE)

cancelled_data = alert_data %>% filter(effect == "NO_SERVICE")
#Then filter about by cancellation 
#These are buses that have have cancelled prior to the event
#Could have alsued used the description text and found Trip Cancelled. 
cancelled_data = cancelled_data %>% filter(grepl("Cancellation", text) == TRUE) %>% select(trip_id) %>% mutate(cancelled = TRUE)
```

```{r}
#Getting our full dataset by joining

df = trip_data %>% 
  left_join(stop_times %>% select("trip_id", "stop_sequence", "arrival_time", "departure_time"), 
            by = c("trip_id" = "trip_id", "stop_sequence" = "stop_sequence")) %>%
  left_join(stops %>% select("stop_id", "stop_lat", "stop_lon"), 
            by = c("stop_id" = "stop_id")) %>%
  left_join(routes %>% select("route_id", "route_short_name"), 
            by = c("route_id" = "route_id")) %>% 
  left_join(cancelled_buses, 
            by = c("trip_id" = "trip_id"))
```











